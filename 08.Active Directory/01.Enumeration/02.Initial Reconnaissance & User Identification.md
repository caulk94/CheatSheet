# Initial Reconnaissance & User Identification
**Concept:** Before attacking the Domain Controller, you must understand the "lay of the land." Who are the users? What are the policies? Where are the targets? 
**Golden Rule:** **Do not start spraying passwords yet.** You must know the lockout policy first.
## 1. Passive & Active Network Discovery
**Goal:** Identify live hosts and capture broadcast traffic to find the Domain Controller (DC) and other key assets.
### Passive Sniffing (Wireshark/Tcpdump)
Listen to the network traffic. You might see broadcast requests (ARP, MDNS, LLMNR) that reveal hostnames and IP addresses.
```shell
# GUI: Start Wireshark
sudo -E wireshark

# CLI: tcpdump (Listen on interface ens224)
sudo tcpdump -i ens224
```
### Responder (Analysis Mode)
Responder is usually an attack tool, but in `-A` (Analyze) mode, it passively listens to LLMNR/NBT-NS requests and logs them without poisoning. This reveals active workstations and the domain name.
```shell
# -I: Interface | -A: Analyze Mode (Passive)
sudo responder -I ens224 -A
```
### Active Scanning (FPing & Nmap)
Once you have an IP range (e.g., `172.16.5.0/23`), identify live hosts.
```shell
# Ping Sweep (FPing)
# -a: Show targets | -s: Stats | -g: Generate IPs from CIDR | -q: Quiet
fping -asgq 172.16.5.0/23

# Nmap Enumeration
# -iL: Input List | -oN: Output Normal
sudo nmap -v -A -iL hosts.txt -oN host-enum.txt
```
## 2. User Enumeration 
### Kerbrute
**Concept:** Brute-forcing usernames against Kerberos (Port 88) is stealthier than SMB because it does not generate Windows Event ID 4625 (Logon Failure) in the same way. It returns "Pre-Auth Required" if the user exists.

**Setup:**
```shell
# 1. Clone & Build
git clone https://github.com/ropnop/kerbrute.git
cd kerbrute && make all

# 2. Move Binary
sudo mv dist/kerbrute_linux_amd64 /usr/local/bin/kerbrute
```

**Enumeration:**
```shell
# Syntax: kerbrute userenum -d <Domain> --dc <DC_IP> <Wordlist>
kerbrute userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o valid_ad_users.txt
```
### Crackmapexec
```shell
crackmapexec smb 192.168.0.1 -u '' -p '' --users

# User LIST:
crackmapexec smb 192.168.0.1 -u 'test_user' -p 'password' --users | awk '{print $5}' | cut -d'\' -f2 > USER_LIST
```
## 3. Password Policy Enumeration (CRITICAL)
**Stop!** Before you try to crack or spray any passwords, you **must** check the **Lockout Threshold**.
- If Threshold = 3, and you spray 5 passwords, you just DoS'd the company.
### From Linux (Authenticated)
If you already have a low-priv user (e.g., `avazquez`):
```shell
# CrackMapExec / NetExec
# --pass-pol: Dump password policy
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
```
### From Linux (Unauthenticated / Null Session)
Try to query the Domain Controller anonymously.
```shell
# Rpcclient (Null Session)
rpcclient -U "" -N 172.16.5.5
rpcclient $> querydominfo

# Enum4Linux (Classic)
enum4linux -P 172.16.5.5

# Enum4Linux-NG (Modern - Faster/Cleaner)
enum4linux-ng -P 172.16.5.5 -oA policy_enum
```
### From Linux (LDAP)
Query LDAP for the `pwdHistoryLength` or `maxPwdAge` attributes anonymously.
```shell
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
```
### From Windows (Inside the Domain)
If you have a foothold on a Windows machine:
```shell
REM Native Command
net accounts
```

```powershell
# PowerView (The Gold Standard)
Import-Module .\PowerView.ps1
Get-DomainPolicy
```
## 4. Security Controls Enumeration
**Goal:** Assess the defensive posture of the compromised host or domain.
### Windows Defender
Check if Real-Time Monitoring is active.
```powershell
Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled, AntispywareSignatureLastUpdated
```
### AppLocker
Check if there are rules preventing you from running `.exe` or `.ps1` files.
```powershell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
```
### PowerShell Constrained Language Mode (CLM)
If this is "ConstrainedLanguage", many tools (like Sherlock or Mimikatz) will fail.
```powershell
$ExecutionContext.SessionState.LanguageMode
```
### LAPS (Local Admin Password Solution)
Check if LAPS is installed. If configured poorly, you might be able to read local admin passwords in cleartext from AD.
```powershell
# Requires PowerView / ActiveDirectory Module
Find-LAPSDelegatedGroups
Find-AdmPwdExtendedRights
Get-LAPSComputers
```